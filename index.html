<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¾›åº”å•†ä¼šè¯æ‹‰é»‘</title>
    <style>
        :root {
            --primary-color: #1890ff;
            --warning-color: #faad14;
            --danger-color: #ff4d4f;
            --success-color: #52c41a;
            --border-color: #e8e8e8;
            --bg-color: #f0f2f5;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #333;
        }

        /* é¡¶éƒ¨é¢åŒ…å±‘ */
        .breadcrumb {
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
        .breadcrumb b {
            color: #333;
        }

        /* ç­›é€‰ä¸æ“ä½œåŒº */
        .layout-container {
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            align-items: center;
        }

        .search-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* é˜²æ­¢å®½åº¦ä¸å¤Ÿæ¢è¡Œ */
        }

        .input-control {
            padding: 6px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            width: 250px; /* ç¨å¾®åŠ å®½ä»¥é€‚åº”æ›´å¤šæœç´¢å†…å®¹ */
            transition: all 0.3s;
        }
        .input-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .btn {
            padding: 6px 16px;
            border: 1px solid #d9d9d9;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn:hover { color: var(--primary-color); border-color: var(--primary-color); }
        
        .btn-primary {
            background: var(--primary-color);
            color: #fff;
            border: none;
        }
        .btn-primary:hover { background: #40a9ff; color: #fff; }

        .btn-danger {
            background: #fff;
            color: var(--danger-color);
            border-color: #ffccc7;
        }
        .btn-danger:hover {
            background: #fff1f0;
            border-color: var(--danger-color);
        }

        /* è¡¨æ ¼åŒº */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th {
            background: #fafafa;
            padding: 14px 16px;
            text-align: left;
            font-weight: 500;
            color: #555;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            color: #333;
        }
        tr:hover td { background: #fdfdfd; }
        
        .reason-text {
            color: #666;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tag-blacklist {
            background: #fff1f0;
            border: 1px solid #ffa39e;
            color: #cf1322;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 12px;
        }
        .tag-whitelist {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 12px;
        }
        
        /* æ‹¦æˆªæ•°ç‚¹å‡»æ ·å¼ */
        .intercept-count {
            font-weight: bold;
            color: #333;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: #ccc;
        }
        .intercept-count:hover {
            color: var(--primary-color);
            text-decoration-color: var(--primary-color);
        }

        /* æ–°å¢ç±»å‹æ ‡ç­¾æ ·å¼ */
        .type-tag {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 2px;
            font-size: 11px;
            margin-right: 4px;
            border: 1px solid transparent;
        }
        .type-sourcing { background: #e6f7ff; border-color: #91d5ff; color: #1890ff; } /* æ‰¾è´§ */
        .type-check { background: #f6ffed; border-color: #b7eb8f; color: #52c41a; } /* æŸ¥å• */
        .type-notify { background: #fff7e6; border-color: #ffd591; color: #fa8c16; } /* é€šçŸ¥ */
        .type-order { background: #fff1f0; border-color: #ffa39e; color: #cf1322; font-weight: bold; } /* ç¦æ­¢ä¸‹å• - ä¸¥é‡ */

        .action-link {
            color: var(--primary-color);
            cursor: pointer;
            margin-right: 12px;
        }
        .action-link.delete { color: var(--danger-color); }

        /* Modal å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #fff;
            width: 500px;
            border-radius: 8px;
            box-shadow: 0 9px 28px rgba(0,0,0,0.05);
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
        }
        .modal-body { padding: 24px; }
        .modal-footer {
            padding: 12px 24px;
            border-top: 1px solid var(--border-color);
            text-align: right;
            background: #fbfbfb;
            border-radius: 0 0 8px 8px;
        }

        .form-item { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input-full { width: 100%; box-sizing: border-box; }
        textarea.form-input-full { height: 80px; resize: vertical; }
        
        /* Checkbox group styles */
        .checkbox-group {
            display: flex;
            gap: 16px;
            margin-top: 6px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        /* æœç´¢ç»“æœä¸‹æ‹‰æ¨¡æ‹Ÿ */
        .search-results {
            border: 1px solid #d9d9d9;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            width: 450px; /* ç•¥å°äºmodalå®½ */
            background: #fff;
            z-index: 10;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
        }
        .search-result-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
        }
        .search-result-item:hover { background: #e6f7ff; }

        /* å¤šé€‰ä¸‹æ‹‰æ ·å¼ */
        .multi-select {
            position: relative;
            min-width: 120px;
            display: inline-block;
        }
        .select-trigger {
            padding: 6px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            background: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .select-trigger:hover { border-color: var(--primary-color); }
        .select-options {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 100%;
            white-space: nowrap;
            background: #fff;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 100;
            margin-top: 4px;
            padding: 4px 0;
            display: none;
        }
        .select-options label {
            display: block;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .select-options label:hover { background: #f5f5f5; }
        .select-options input[type="checkbox"] { margin: 0; }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Toast æ¶ˆæ¯æç¤º */
        .toast-message {
            position: fixed;
            top: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 10px 24px;
            border-radius: 4px;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast-message.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="breadcrumb">AIæ’ä»¶ / <b>ä¾›åº”å•†ä¼šè¯æ‹‰é»‘</b></div>

    <div class="layout-container">
        <!-- é¡¶éƒ¨æ“ä½œæ  -->
        <div class="action-bar">
            <div class="search-group">
                <select id="filterStatus" class="input-control" style="width: 110px;" onchange="renderTable()">
                    <option value="all" selected>çŠ¶æ€: å…¨éƒ¨</option>
                    <option value="active">å·²æ‹‰é»‘</option>
                    <option value="inactive">å·²æ¢å¤</option>
                </select>
                
                <!-- Multi-select for Type -->
                <div class="multi-select" id="typeMultiSelect">
                    <div class="select-trigger" onclick="toggleTypeSelect(event)">
                        <span id="typeSelectLabel">ç±»å‹: å…¨éƒ¨</span>
                        <small>â–¼</small>
                    </div>
                    <div class="select-options" id="typeSelectOptions">
                        <label><input type="checkbox" value="æ‰¾è´§" checked onchange="updateTypeLabel(); renderTable()"> æ‰¾è´§</label>
                        <label><input type="checkbox" value="æŸ¥å•" checked onchange="updateTypeLabel(); renderTable()"> æŸ¥å•</label>
                        <label><input type="checkbox" value="é€šçŸ¥" checked onchange="updateTypeLabel(); renderTable()"> é€šçŸ¥</label>
                    </div>
                </div>

                <input type="text" class="input-control" placeholder="æœç´¢æ—ºæ—ºå·/å…¬å¸å/ID" id="searchInput">
                <button class="btn btn-primary" onclick="renderTable()">æœç´¢</button>
                <button class="btn" onclick="resetSearch()">é‡ç½®</button>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 13px; color: #666;">
                    åˆ·æ–°æ—¶é—´: <span id="refreshTimeDisplay">--</span>
                    <i style="cursor: pointer; margin-left: 4px;" onclick="refreshList()" title="åˆ·æ–°åˆ—è¡¨">â†»</i>
                </span>
               
               
                <button class="btn btn-danger" onclick="addBlacklist()">+ æ–°å¢æ‹‰é»‘ä¾›åº”å•†</button>
            </div>
        </div>

        <!-- åˆ—è¡¨ -->
        <table>
            <thead>
                <tr>
                    <th width="120">ä¾›åº”å•†ID</th>
                    <th width="150">ä¾›åº”å•†æ—ºæ—ºå·</th>
                    <th width="200">ä¾›åº”å•†å…¬å¸åç§°</th>
                    <th width="150">æ‹‰é»‘ç±»å‹</th>
                    <th width="80">æœ¬æœˆæ‹¦æˆª</th>
                    <th>æ‹‰é»‘åŸå› </th>
                    <th width="160" style="cursor: pointer; user-select: none;" onclick="toggleSort()" title="ç‚¹å‡»åˆ‡æ¢æŒ‰æ—¶é—´æ’åº">
                        æ—¶é—´ <span id="sortTimeIcon">â†“</span>
                    </th>
                    <th width="80">æ“ä½œäºº</th>
                    <th width="80">çŠ¶æ€</th>
                    <th width="100">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="blacklistBody">
                <!-- JS æ¸²æŸ“ -->
            </tbody>
        </table>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            æš‚æ— æ‹‰é»‘æ•°æ®
        </div>

        <div style="margin-top: 20px; text-align: center; color: #999; font-size: 13px;">
            å½“å‰ä»…å±•ç¤ºé—®è¯¢æ‹‰é»‘çš„ä¾›åº”å•†åˆ—è¡¨ï¼Œå¦‚éœ€æŸ¥çœ‹ç¦æ­¢ä¸‹å•çš„ä¾›åº”å•†åˆ—è¡¨ï¼Œè¯·å‰å¾€â€œä¾›åº”å•†ç®¡ç†â€åˆ—è¡¨æŸ¥çœ‹
        </div>
    </div>

    <!-- æ–°å¢å¼¹çª— -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                æ–°å¢æ‹‰é»‘ä¾›åº”å•†
                <span style="cursor:pointer;color:#999" onclick="closeModal()">âœ•</span>
            </div>
            <div class="modal-body">
                <div class="form-item" style="position: relative;">
                    <label class="form-label">ä¾›åº”å•†æ—ºæ—ºå· <span style="color:red">*</span></label>
                    <input type="text" class="input-control form-input-full" id="supplierSearch" placeholder="è¾“å…¥æ—ºæ—ºå·æˆ–å…¬å¸åæœç´¢..." oninput="simulateSearch(this.value)">
                    <div class="search-results" id="searchResults">
                        <!-- æœç´¢ç»“æœ -->
                    </div>
                </div>
                <div class="form-item">
                    <label class="form-label">ä¾›åº”å•†å…¬å¸åç§°</label>
                    <input type="text" class="input-control form-input-full" id="companyNameInput" placeholder="è¯·è¾“å…¥å…¬å¸åç§°ï¼ˆé€‰å¡«ï¼‰">
                </div>
                
                <div class="form-item">
                    <label class="form-label">æ‹‰é»‘ç±»å‹ <span style="color:red">*</span></label>
                    <div class="checkbox-group" style="flex-wrap: wrap;">
                        <label class="checkbox-label"><input type="checkbox" name="blockType" value="æ‰¾è´§" checked> æ‰¾è´§</label>
                        <label class="checkbox-label"><input type="checkbox" name="blockType" value="æŸ¥å•" checked> æŸ¥å•</label>
                        <label class="checkbox-label"><input type="checkbox" name="blockType" value="é€šçŸ¥" checked> é€šçŸ¥</label>
                    </div>
                    <div style="font-size: 12px; color: #999; margin-top: 6px;">æ³¨ï¼šå‹¾é€‰ç›¸åº”ç±»å‹ï¼Œç³»ç»Ÿå°†å±è”½å¯¹åº”åœºæ™¯çš„ä»»åŠ¡ã€‚</div>
                </div>

                <div class="form-item">
                    <label class="form-label">æ‹‰é»‘åŸå›  <span style="color:red">*</span></label>
                    <textarea class="input-control form-input-full" id="blockReason" placeholder="ä¾‹å¦‚ï¼šå‘è´§ææ…¢ï¼Œç»å¸¸ç¼ºè´§ï¼Œæ€åº¦æ¶åŠ£ç­‰..."></textarea>
                    <div style="font-size: 12px; color: #ff4d4f; margin-top: 4px;">âš ï¸ æ‹‰é»‘åï¼Œç³»ç»Ÿå°†ä¸å†å¯¹æ­¤ä¾›åº”å•†ç”Ÿæˆä»»ä½•è‡ªåŠ¨é—®è¯¢ä»»åŠ¡ï¼</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveBlacklist()">ç¡®è®¤æ‹‰é»‘</button>
            </div>
        </div>
    </div>

    <!-- æ‹¦æˆªè¯¦æƒ…å¼¹çª— -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal" style="width: 600px;">
            <div class="modal-header">
                <div>æ‹¦æˆªæ˜ç»† - <span id="detailSupplierName"></span></div>
                <span style="cursor:pointer;color:#999" onclick="closeDetailModal()">âœ•</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <table style="border: none;">
                    <thead>
                        <tr>
                            <th style="background: #fff; border-bottom: 2px solid #f0f0f0;">æ‹¦æˆªæ—¶é—´</th>
                            <th style="background: #fff; border-bottom: 2px solid #f0f0f0;">ä¸šåŠ¡ç±»å‹</th>
                            <th style="background: #fff; border-bottom: 2px solid #f0f0f0;">è§¦å‘è§„åˆ™</th>
                            <th style="background: #fff; border-bottom: 2px solid #f0f0f0;">çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="detailBody">
                        <!-- JS æ¸²æŸ“ -->
                    </tbody>
                </table>
                <div id="detailEmpty" style="text-align: center; padding: 30px; color: #999; display: none;">
                    æš‚æ— æœ¬æœˆæ‹¦æˆªè®°å½•
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæ—¥å¿—å¼¹çª— -->
    <div class="modal-overlay" id="logModal">
        <div class="modal" style="width: 700px;">
            <div class="modal-header">
                <div>æ“ä½œæ—¥å¿—</div>
                <span style="cursor:pointer;color:#999" onclick="closeLogModal()">âœ•</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <table style="border: none;">
                    <thead>
                        <tr>
                            <th style="background: #fff; border-bottom: 2px solid #f0f0f0; width: 160px;">æ“ä½œæ—¶é—´</th>
                            <th style="background: #fff; border-bottom: 2px solid #f0f0f0; width: 100px;">æ“ä½œäºº</th>
                            <th style="background: #fff; border-bottom: 2px solid #f0f0f0;">æ“ä½œå†…å®¹</th>
                        </tr>
                    </thead>
                    <tbody id="logBody">
                        <!-- JS æ¸²æŸ“ -->
                    </tbody>
                </table>
                <div id="logEmpty" style="text-align: center; padding: 30px; color: #999; display: none;">
                    æš‚æ— æ“ä½œè®°å½•
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeLogModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå·²å­˜åœ¨çš„æ•°æ®
        // å¢åŠ  status å­—æ®µ: 'active' (ç”Ÿæ•ˆä¸­), 'inactive' (å·²è§£é™¤)
        // å¢åŠ  recordId ç”¨äºå”¯ä¸€æ ‡è¯†æ¯æ¡è®°å½•
        let blacklistData = [
            { recordId: 'rec_0', id: 'SUP_9999', wangwang: 'bad_seller_007', companyName: 'è¯šä¿¡ç¼ºå¤±è´¸æ˜“è¡Œ', types: ['ä¸‹å•', 'æ‰¾è´§', 'æŸ¥å•', 'é€šçŸ¥'], interceptCount: 0, reason: 'æ¶‰å«Œå”®å‡ï¼Œå¹³å°å·²é€šæŠ¥', time: '2025-01-20 16:00:00', operator: 'é£æ§ç³»ç»Ÿ', status: 'active' },
            { recordId: 'rec_1', id: 'SUP_1001', wangwang: 'tb_shop_1001', companyName: 'ä¹‰ä¹Œå¸‚å°å•†å“ç²¾é€‰åº—', types: ['æ‰¾è´§', 'æŸ¥å•'], interceptCount: 42, reason: 'å¤šæ¬¡å‘é”™è´§ï¼Œä¸”æ‹’ç»æ‰¿æ‹…è¿è´¹', time: '2025-09-01 10:22:11', operator: 'å¼ ä¸‰', status: 'active' },
            { recordId: 'rec_2', id: 'SUP_2001', wangwang: 'hz_silk_direct', companyName: 'æ­å·ä¸ç»¸ç›´ä¾›', types: ['æŸ¥å•'], interceptCount: 5, reason: 'é…åˆåº¦ä½', time: '2024-12-11 09:30:00', operator: 'æå››', status: 'inactive', releaseTime: '2025-01-01 09:00:00' },
            { recordId: 'rec_3', id: 'SUP_2002', wangwang: 'sh_stationary_fac', companyName: 'ä¸Šæµ·æ–‡å…·ç”¨å“åˆ¶é€ å‚', types: ['æ‰¾è´§'], interceptCount: 1, reason: 'ä¸´æ—¶ç¼ºè´§', time: '2024-11-20 14:00:00', operator: 'ç‹äº”', status: 'inactive', releaseTime: '2024-11-25 10:00:00' }
        ];

        // æ¨¡æ‹Ÿå…¨é‡ä¾›åº”å•†åº“ï¼ˆç”¨äºæœç´¢ï¼‰
        const supplierDb = [
            { id: 'SUP_1001', wangwang: 'tb_shop_1001', companyName: 'ä¹‰ä¹Œå¸‚å°å•†å“ç²¾é€‰åº—' },
            { id: 'SUP_1002', wangwang: 'gz_clothing_wh', companyName: 'å¹¿å·æœè£…æ‰¹å‘æ€»ä»“' },
            { id: 'SUP_1003', wangwang: 'sz_elec_factory', companyName: 'æ·±åœ³ç”µå­å…ƒä»¶å‚' },
            { id: 'SUP_1004', wangwang: 'hz_textile_ltd', companyName: 'æ­å·çººç»‡æœ‰é™å…¬å¸' },
            { id: 'SUP_2001', wangwang: 'hz_silk_direct', companyName: 'æ­å·ä¸ç»¸ç›´ä¾›' },
            { id: 'SUP_2002', wangwang: 'sh_stationary_fac', companyName: 'ä¸Šæµ·æ–‡å…·ç”¨å“åˆ¶é€ å‚' },
            { id: 'SUP_2003', wangwang: 'yiwu_acc_c', companyName: 'ä¹‰ä¹Œé¥°å“é…ä»¶CåŒº' },
            { id: 'SUP_2004', wangwang: 'sz_digi_3c', companyName: 'æ·±åœ³æ•°ç 3Cä¸“è¥' },
            { id: 'SUP_2005', wangwang: 'bj_specialty', companyName: 'åŒ—äº¬ç‰¹äº§ä»£å‘' },
            { id: 'SUP_9999', wangwang: 'bad_seller_007', companyName: 'è¯šä¿¡ç¼ºå¤±è´¸æ˜“è¡Œ' }
        ];

        let selectedSupplier = null;
        let currentSortOrder = 'desc'; // é»˜è®¤å€’åº

        // Toast æ¶ˆæ¯æç¤ºå‡½æ•°
        function showToast(msg, duration = 3000) {
            const div = document.createElement('div');
            div.className = 'toast-message';
            div.innerText = msg;
            document.body.appendChild(div);
            // è§¦å‘åŠ¨ç”»
            requestAnimationFrame(() => {
                div.classList.add('show');
            });
            setTimeout(() => {
                div.classList.remove('show');
                setTimeout(() => div.remove(), 300);
            }, duration);
        }

        // æ¨¡æ‹Ÿæ‹¦æˆªè¯¦ç»†æ•°æ®
        function generateMockLogs(count) {
            const logs = [];
            const types = ['æ‰¾è´§', 'æŸ¥å•', 'é€šçŸ¥'];
            for(let i=0; i<count; i++) {
                logs.push({
                    time: `2025-02-${String(Math.floor(Math.random()*28)+1).padStart(2,'0')} ${String(Math.floor(Math.random()*14)+8).padStart(2,'0')}:${String(Math.floor(Math.random()*59)).padStart(2,'0')}`,
                    type: types[Math.floor(Math.random() * types.length)],
                    rule: 'é»‘åå•å‘½ä¸­',
                    status: 'å·²æ‹¦æˆª'
                });
            }
            // æŒ‰æ—¶é—´å€’åº
            return logs.sort((a,b) => new Date(b.time) - new Date(a.time));
        }
        
        // ç¼“å­˜éƒ¨åˆ†æ•°æ®çš„æ—¥å¿—ï¼Œé¿å…æ¯æ¬¡éšæœºå˜åŒ–
        const logCache = {};

        // Multi-select Logic
        function toggleTypeSelect(e) {
            e.stopPropagation();
            const opts = document.getElementById('typeSelectOptions');
            const isVisible = opts.style.display === 'block';
            closeAllSelects();
            if (!isVisible) {
                opts.style.display = 'block';
            }
        }
        
        function closeAllSelects() {
            document.getElementById('typeSelectOptions').style.display = 'none';
        }

        window.onclick = function(event) {
            if (!event.target.closest('.multi-select')) {
                closeAllSelects();
            }
        }

        function updateTypeLabel() {
            const checkboxes = document.querySelectorAll('#typeSelectOptions input[type="checkbox"]');
            const checked = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            const label = document.getElementById('typeSelectLabel');
            
            if (checked.length === 0) {
                label.innerText = 'ç±»å‹: æ— ';
            } else if (checked.length === checkboxes.length) {
                label.innerText = 'ç±»å‹: å…¨éƒ¨';
            } else {
                label.innerText = `ç±»å‹: å·²é€‰(${checked.length})`;
            }
        }

        function refreshList() {
            updateRefreshTime();
            renderTable();
            showToast('åˆ—è¡¨å·²åˆ·æ–°');
        }

        function updateRefreshTime() {
            const now = new Date();
            const timeStr = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' + 
                String(now.getHours()).padStart(2, '0') + ':' + 
                String(now.getMinutes()).padStart(2, '0') + ':' + 
                String(now.getSeconds()).padStart(2, '0');
            document.getElementById('refreshTimeDisplay').innerText = timeStr;
        }

        // åˆå§‹åŒ–
        updateRefreshTime();
        renderTable();

        function toggleSort() {
            currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
            const icon = document.getElementById('sortTimeIcon');
            if (icon) {
                icon.innerText = currentSortOrder === 'desc' ? 'â†“' : 'â†‘';
            }
            renderTable();
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('blacklistBody');
            const searchVal = document.getElementById('searchInput').value.trim().toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const typeCheckboxes = document.querySelectorAll('#typeSelectOptions input[type="checkbox"]');
            const selectedTypes = Array.from(typeCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            const emptyState = document.getElementById('emptyState');
            
            tbody.innerHTML = '';

            let filtered = blacklistData.filter(item => {
                // æ–‡æœ¬æœç´¢
                const matchText = (item.wangwang && item.wangwang.toLowerCase().includes(searchVal)) || 
                                  (item.companyName && item.companyName.toLowerCase().includes(searchVal)) ||
                                  item.id.toLowerCase().includes(searchVal);
                
                // çŠ¶æ€ç­›é€‰
                const matchStatus = filterStatus === 'all' || item.status === filterStatus;

                // ç±»å‹ç­›é€‰ (Multi-select)
                let matchType = false;
                if (selectedTypes.length === 0) {
                    matchType = false;
                } else {
                    if (item.types && item.types.some(t => selectedTypes.includes(t))) {
                        matchType = true;
                    }
                }
                
                return matchText && matchStatus && matchType;
            });

            // æ’åºï¼šæŒ‰æœ€æ–°ç›¸å…³æ—¶é—´æ’åºï¼ˆç”Ÿæ•ˆä¸­=æ‹‰é»‘æ—¶é—´ï¼Œå·²è§£é™¤=æ¢å¤æ—¶é—´ï¼‰
            filtered.sort((a, b) => {
                const parseDate = (str) => {
                    if (!str) return 0;
                    return new Date(str.replace(/-/g, '/')).getTime();
                };

                const getTime = (item) => {
                    if (item.status !== 'active' && item.releaseTime) {
                        return parseDate(item.releaseTime);
                    }
                    return parseDate(item.time);
                };

                const timeA = getTime(a);
                const timeB = getTime(b);
                
                if (currentSortOrder === 'asc') {
                    return timeA - timeB;
                } else {
                    return timeB - timeA;
                }
            });

            if (filtered.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            filtered.forEach((item, index) => {
                let typesHtml = '';
                if (item.types && item.types.includes('æ‰¾è´§')) typesHtml += `<span class="type-tag type-sourcing">æ‰¾è´§</span>`;
                if (item.types && item.types.includes('æŸ¥å•')) typesHtml += `<span class="type-tag type-check">æŸ¥å•</span>`;
                if (item.types && item.types.includes('é€šçŸ¥')) typesHtml += `<span class="type-tag type-notify">é€šçŸ¥</span>`;
                if (!typesHtml) typesHtml = '-';

                // åªæœ‰ interceptCount > 0 æ‰åŠ ç‚¹å‡»äº‹ä»¶ï¼Œä¸”ä¼ é€’ id ä»¥ä¾¿æŸ¥æ‰¾
                const countHtml = item.interceptCount > 0 
                    ? `<span class="intercept-count" onclick="showInterceptDetails('${item.id}', '${item.wangwang}', ${item.interceptCount})">${item.interceptCount} å•</span>` 
                    : `<span style="color:#ccc">0</span>`;
                
                const isActive = item.status === 'active';
                const statusHtml = isActive 
                    ? `<span class="tag-blacklist">å·²æ‹‰é»‘</span>` 
                    : `<span class="tag-whitelist">å·²æ¢å¤</span>`;
                
                let timeHtml = '';
                if (item.status !== 'active' && item.releaseTime) {
                    timeHtml += `<div style="color:#52c41a;font-size:12px;font-weight:500">æ¢å¤: ${item.releaseTime.split(' ')[0]}</div>`;
                    timeHtml += `<div style="color:#999;font-size:12px">æ‹‰é»‘: ${item.time.split(' ')[0]}</div>`;
                } else {
                    timeHtml += `<div style="color:#666;font-size:12px">æ‹‰é»‘: ${item.time.split(' ')[0]}</div>`;
                }

                const actionHtml = isActive
                    ? `<span class="action-link delete" onclick="releaseBlacklist('${item.recordId}')">è§£é™¤æ‹‰é»‘</span>`
                    : `<span class="action-link" onclick="reBlockSupplier('${item.recordId}')">é‡æ–°æ‹‰é»‘</span>`;
            
                const tr = document.createElement('tr');
                if (!isActive) tr.style.background = '#fafafa';

                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td><b>${item.wangwang}</b></td>
                    <td>${item.companyName || '-'}</td>
                    <td>${typesHtml}</td>
                    <td>${countHtml}</td>
                    <td><div class="reason-text" title="${item.reason}">${item.reason}</div></td>
                    <td>${timeHtml}</td>
                    <td>${item.operator}</td>
                    <td>${statusHtml}</td>
                    <td>${actionHtml}<span class="action-link" onclick="showLog('${item.id}')">æ—¥å¿—</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showInterceptDetails(id, name, count) {
             // 1. è®¾ç½®æ ‡é¢˜
             document.getElementById('detailSupplierName').innerText = name;
             
             // 2. è·å–æˆ–ç”Ÿæˆæ•°æ®
             let logs = logCache[id];
             if (!logs) {
                 logs = generateMockLogs(count);
                 logCache[id] = logs;
             }
             
             // 3. æ¸²æŸ“åˆ—è¡¨
             const tbody = document.getElementById('detailBody');
             const empty = document.getElementById('detailEmpty');
             tbody.innerHTML = '';
             
             if (logs.length === 0) {
                 empty.style.display = 'block';
             } else {
                 empty.style.display = 'none';
                 logs.forEach(log => {
                     const tr = document.createElement('tr');
                     let typeClass = '';
                     if(log.type === 'æ‰¾è´§') typeClass = 'type-sourcing';
                     else if(log.type === 'æŸ¥å•') typeClass = 'type-check';
                     else if(log.type === 'é€šçŸ¥') typeClass = 'type-notify';
                     
                     tr.innerHTML = `
                        <td style="color:#666">${log.time}</td>
                        <td><span class="type-tag ${typeClass}">${log.type}</td>
                        <td>${log.rule}</td>
                        <td><span style="color:#ff4d4f;background:#fff1f0;padding:2px 6px;border-radius:2px;font-size:12px;">ğŸš« ${log.status}</span></td>
                     `;
                     tbody.appendChild(tr);
                 });
             }

             // 4. æ˜¾ç¤ºå¼¹çª—
             document.getElementById('detailModal').style.display = 'flex';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = 'all'; 
            document.querySelectorAll('#typeSelectOptions input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateTypeLabel();
            renderTable();
        }

        function addBlacklist() {
            document.getElementById('addModal').style.display = 'flex';
            document.getElementById('supplierSearch').value = '';
            document.getElementById('companyNameInput').value = ''; 
            document.getElementById('blockReason').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.querySelectorAll('input[name="blockType"]').forEach(cb => cb.checked = true);
            selectedSupplier = null;
        }

        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        function simulateSearch(val) {
            const resultBox = document.getElementById('searchResults');
            if (!val) {
                resultBox.style.display = 'none';
                return;
            }
            
            const results = supplierDb.filter(s => 
                (s.wangwang.includes(val) || s.companyName.includes(val)) && 
                !blacklistData.find(b => b.id === s.id && b.status === 'active')
            );
            
            if (results.length > 0) {
                resultBox.innerHTML = results.map(s => `
                    <div class="search-result-item" onclick="selectSupplier('${s.id}', '${s.wangwang}', '${s.companyName}')">
                        <span style="font-weight:bold">${s.wangwang}</span> 
                        <span style="color:#666;font-size:12px">(${s.companyName})</span>
                    </div>
                `).join('');
                resultBox.style.display = 'block';
            } else {
                resultBox.innerHTML = '<div style="padding:8px;color:#999">æœªæ‰¾åˆ°åŒ¹é…çš„ä¾›åº”å•†æˆ–å·²åœ¨é»‘åå•ä¸­</div>';
                resultBox.style.display = 'block';
            }
        }

        function selectSupplier(id, wangwang, companyName) {
            selectedSupplier = { id, wangwang, companyName };
            document.getElementById('supplierSearch').value = wangwang;
            document.getElementById('companyNameInput').value = companyName;
            document.getElementById('searchResults').style.display = 'none';
        }

        function saveBlacklist() {
            const reason = document.getElementById('blockReason').value;
            const searchInput = document.getElementById('supplierSearch').value;
            const companyInput = document.getElementById('companyNameInput').value;
            
            const selectedTypes = [];
            document.querySelectorAll('input[name="blockType"]:checked').forEach(cb => {
                selectedTypes.push(cb.value);
            });

            if (!selectedSupplier && !searchInput) {
                showToast('è¯·å¡«å†™ä¾›åº”å•†æ—ºæ—ºå·');
                return;
            }

            if (selectedTypes.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ‹‰é»‘ç±»å‹');
                return;
            }

            const newItem = {
                recordId: 'rec_' + Date.now(),
                id: selectedSupplier ? selectedSupplier.id : ('SUP_NEW_' + Math.floor(Math.random()*1000)),
                wangwang: selectedSupplier ? selectedSupplier.wangwang : searchInput,
                companyName: selectedSupplier ? selectedSupplier.companyName : companyInput,
                types: selectedTypes,
                interceptCount: 0, 
                reason: reason || 'æœªå¡«å†™åŸå› ',
                time: new Date().toLocaleString().replace(/\//g,'-'),
                operator: 'å½“å‰ç”¨æˆ·',
                status: 'active'
            };

            blacklistData.unshift(newItem);
            
            // è®°å½•æ—¥å¿—
            addSystemLog(`æ–°å¢æ‹‰é»‘ä¾›åº”å•†ï¼š${newItem.wangwang} (${newItem.id})`);
            
            renderTable();
            closeModal();
            showToast(`å·²å°†ã€${newItem.wangwang}ã€‘åŠ å…¥é»‘åå•`);
        }

        function reBlockSupplier(recordId) {
            const item = blacklistData.find(i => i.recordId === recordId);
            if (!item) return;

            addBlacklist();
            
            document.getElementById('supplierSearch').value = item.wangwang;
            document.getElementById('companyNameInput').value = item.companyName || '';
            
            selectedSupplier = { id: item.id, wangwang: item.wangwang, companyName: item.companyName };
        }

        function releaseBlacklist(recordId) {
            if(confirm('ç¡®å®šè¦è§£é™¤è¯¥ä¾›åº”å•†çš„é»‘åå•å—ï¼Ÿ\nè§£é™¤åï¼Œè¯¥ä¾›åº”å•†å°†æ¢å¤æ­£å¸¸ï¼Œå¯ä»¥ç”Ÿæˆé—®è¯¢ä»»åŠ¡ã€‚')) {
                const target = blacklistData.find(item => item.recordId === recordId);
                if (target) {
                    target.status = 'inactive';
                    target.releaseTime = new Date().toLocaleString().replace(/\//g,'-');
                    target.releaseOperator = 'å½“å‰ç”¨æˆ·';
                    
                    // è®°å½•æ—¥å¿—
                    addSystemLog(`è§£é™¤æ‹‰é»‘ï¼š${target.wangwang} (${target.id})`);

                    renderTable();
                    
                    const currentFilter = document.getElementById('filterStatus').value;
                    if (currentFilter === 'active') {
                        showToast(`ä¾›åº”å•†å·²æ¢å¤æ­£å¸¸ï¼å·²ç§»è‡³[å·²è§£é™¤]åˆ—è¡¨ã€‚`);
                    } else {
                        showToast(`ä¾›åº”å•†å·²æ¢å¤æ­£å¸¸ï¼`);
                    }
                }
            }
        }

        function exportData() {
            // ç”Ÿæˆ CSV å†…å®¹
            const headers = ['ä¾›åº”å•†ID', 'ä¾›åº”å•†æ—ºæ—ºå·', 'ä¾›åº”å•†å…¬å¸åç§°', 'æ‹‰é»‘ç±»å‹', 'æœ¬æœˆæ‹¦æˆªæ•°', 'æ‹‰é»‘åŸå› ', 'æ‹‰é»‘æ—¶é—´', 'æ“ä½œäºº', 'çŠ¶æ€'];
            const rows = blacklistData.map(item => [
                item.id,
                item.wangwang,
                item.companyName || '',
                item.types.join('/'),
                item.interceptCount,
                item.reason,
                item.time,
                item.operator,
                item.status === 'active' ? 'å·²æ‹‰é»‘' : 'å·²æ¢å¤'
            ]);
            
            let csvContent = "\uFEFF" + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "blacklist_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // è®°å½•æ—¥å¿—
            addSystemLog('å¯¼å‡ºé»‘åå•æ•°æ®');
            showToast('æ•°æ®å¯¼å‡ºæˆåŠŸï¼å·²ä¿å­˜ä¸º blacklist_export.csv');
        }

        function showLog(filterId) {
            renderSystemLogs(filterId);
            document.getElementById('logModal').style.display = 'flex';
        }

        function closeLogModal() {
            document.getElementById('logModal').style.display = 'none';
            // ç®€å•å®ç°ç‚¹å‡»é®ç½©å…³é—­
        }
        
        document.getElementById('logModal').addEventListener('click', (e) => {
            if (e.target.id === 'logModal') closeLogModal();
        });

        function renderSystemLogs(filterId) {
            const tbody = document.getElementById('logBody');
            const empty = document.getElementById('logEmpty');
            tbody.innerHTML = '';
            
            // æŒ‰æ—¶é—´å€’åº
            let sortedLogs = [...systemLogs].sort((a, b) => new Date(b.time) - new Date(a.time));

            if (filterId && typeof filterId === 'string') {
                sortedLogs = sortedLogs.filter(log => log.content.includes(filterId));
            }

            if (sortedLogs.length === 0) {
                empty.style.display = 'block';
            } else {
                empty.style.display = 'none';
                sortedLogs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="color:#666">${log.time}</td>
                        <td>${log.operator}</td>
                        <td>${log.content}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }
        
        function addSystemLog(content) {
             const now = new Date();
             const timeStr = now.getFullYear() + '-' + 
                String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                String(now.getDate()).padStart(2, '0') + ' ' + 
                String(now.getHours()).padStart(2, '0') + ':' + 
                String(now.getMinutes()).padStart(2, '0') + ':' + 
                String(now.getSeconds()).padStart(2, '0');
                
             systemLogs.unshift({
                 id: Date.now(),
                 time: timeStr,
                 operator: 'å½“å‰ç”¨æˆ·',
                 content: content
             });
        }

        // æ¨¡æ‹Ÿç³»ç»Ÿæ“ä½œæ—¥å¿—æ•°æ®
        let systemLogs = [
            { id: 1, time: '2025-02-02 14:20:01', operator: 'å¼ ä¸‰', content: 'æ–°å¢æ‹‰é»‘ä¾›åº”å•†ï¼šä¹‰ä¹Œå¸‚å°å•†å“ç²¾é€‰åº— (SUP_1001)' },
            { id: 2, time: '2025-02-02 09:15:33', operator: 'æå››', content: 'è§£é™¤æ‹‰é»‘ï¼šæ­å·ä¸ç»¸ç›´ä¾› (SUP_2001)' },
            { id: 3, time: '2025-02-01 16:45:10', operator: 'Admin', content: 'å¯¼å‡ºé»‘åå•æ•°æ®' },
            { id: 4, time: '2025-01-20 16:00:00', operator: 'é£æ§ç³»ç»Ÿ', content: 'è‡ªåŠ¨æ‹‰é»‘ï¼šè¯šä¿¡ç¼ºå¤±è´¸æ˜“è¡Œ (SUP_9999)' }
        ];

        document.getElementById('addModal').addEventListener('click', (e) => {
            if (e.target.id === 'addModal') closeModal();
        });

        // å¢åŠ æ˜ç»†å¼¹çª—çš„é®ç½©ç‚¹å‡»å…³é—­
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') closeDetailModal();
        });

    </script>
</body>
</html>


